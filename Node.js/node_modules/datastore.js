var Ds,
	Net,
	fs,
	inmemory=1;
if (typeof exports !== 'undefined') {
	Net=require('net.js')
	fs=require('fs')
	inmemory=0
}
(function(){
	Ds={
		id: 'ds',
		path: 'ds',
		type: 'ds',
		items:{},
		conds: {
			'==': function(v1,v2){
				if (v1==v2) return true;
				return false;
			},
			'!=': function(v1,v2){
				if (v1!=v2) return true;
				return false;
			},
			'<': function(v1,v2){
				if (v1<v2) return true;
				return false;
			},
			'>': function(v1,v2){
				if (v1>v2) return true;
				return false;
			}
		},
		count: 0,
		'new': function(id,inmem){
			var obj=Obj();
			obj.id=id;
			obj.path='DS/'+id;
			obj.type='ds';
			obj.ds=obj;
			if (!inmemory) {
				obj.inmemory=inmem || 0;
			} else {
				obj.inmemory=inmemory;
			}
			if (obj.inmemory==0){
				//console.log('save:',obj.path)
				obj.set();
			}
			//console.log('new ds:',obj.path);
			return obj;
		},		
		open: function(path){			
		},
		close: function(id){		
		},
		add: function(data){
			var item=Obj(data);			
			if (item.id=='') item.id=this.genid()
			item.path=this.path+'/'+item.id;
			item.parent=this;
			if (this.pre){
				item.ext='.ds';
				delete item.items;
			}
			//console.log('add:',item.path);
			item.ds=this.ds;
			this.items[item.id]=item;
			this.count+=1;		
			//item.set();
			if (item.ds.inmemory==0){				
				item.set();
			}
			return item;
		},
		rem: function(data){
			if (data){				
				var item=this.items[data];
				if (item){
					delete this.items[data];
					this.count-=1;
					return item;
				}
			} else {
				if (this.ds.inmemory==0){
					fs.unlink(this.path+this.ext,function(err){
						if(err) throw err;
					});					
				}									
				delete this.parent.items[this.id];
			}
			return false;
		},
		get: function(str){
			console.log('get:',str);
			var res=[],
				cond,
				item;
			if (!str){
				res=this.items;
			} else {			
				for (var name in Ds.conds){
					cond=name;
					if (str.indexOf(name)!=-1) break;
					cond='';
				}			
				if (!cond) {
					res=this.items[str];
				} else {
					var vals=str.split(cond);
					for (var key in this.items){
						item=this.items[key];
						if (Ds.conds[cond](item[vals[0]],vals[1])){
							res.push(item);
						}
					}					
				}
			}
			return res;
		},
		set: function(){
			var obj={},
				plist=[],
				path,
				circular=['add','rem','get','set','genid','new','open','close','parent','save','ds','pre','count','path','ext'],
				data;
			for(var key in this){				
				if (circular.indexOf(key)==-1)
					obj[key]=this[key];
			}		
			data=JSON.stringify(obj)
			//console.log('save:',obj.path);			
			
			var parts=this.path.split('/'),
				cp='',
				last=parts.length-1;
			for(var nr in parts){				
				if (nr==last && this.ext){
					cp+='/'+parts[nr]+this.ext;
					fs.writeFile(cp,data,function(err){
						if (err) throw err;
					})
				} else {
					if (nr==0){
						cp+=parts[nr];
					} else {
						cp+='/'+parts[nr];
					}					
					console.log('mkdir:',cp);
					if (!fs.existsSync(cp)){
						console.log('mkdir:',cp);
						fs.mkdirSync(cp,function(err){
							if (err) throw err;
						})
					}
				}
			}			
		},
		genid: function(pre,after){
			pre=pre || '';
			after=after || '';
			var id=this.pre+(new Date().getTime()+after);
			//console.log('genid:',this,this.items);
			while(id in this.items){
				id=this.pre+((new Date().getTime()+1)+after);
			}
			return id;
		}	
	}
	function Obj(conf){
		var obj={
			id: '',
			pre: '',
			ext: '',
			path: '',
			parent: 0,
			ds:'',
			items: {},
			count: 0,
			add: Ds.add,
			rem: Ds.rem,
			get: Ds.get,
			set: Ds.set,
			genid: Ds.genid,
			save: Ds.save
		}
		for(var key in conf){
			obj[key]=conf[key];
		}		
		return obj;
	}
	
	//test
	var ds1=Ds.new('ds1'),
		users=ds1.add({
			id: 'users',
			pre: 'users-'
		});
	var user=users.add({
		name: 'user1',
		age: 21
	})
	var user=users.add({
		name: 'user2',
		age: 26
	})
	var user=users.add({
		name: 'user3',
		age: 21
	})
	console.log(users.get('age==21'));
})()	
if (typeof exports !== 'undefined') exports.Ds =Ds;
console.log('Loaded Ds');
