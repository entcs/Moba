<head>
	<link href='http://fonts.googleapis.com/css?family=Open+Sans+Condensed:700,300' rel='stylesheet' type='text/css'>
</head>
<script src='d0.js'></script>
<script src='c0.js'></script>
<!---->
<script>
var basket={}
d.on('ready',function(e){	
	var flip=false
	basket={
		acts:[],
		pl:-1,
		act:-1,
		col:'',	
		team:0,
		gtime:0,
		dgtime:1000*60*60*12,
		quarter:1,
		otime:0,
		dotime:24*1000,
		sotime:14*1000,
		timeout:0,
		dttime:60*1000,
		ct:0,
		lt:0,
		dt:0,
		setstyles:function(){
			var sheet=d.dss.new('basesheet'),
				col1='background-color:yellowgreen',
				col2='background-color:#333',
				col3='background-color:#eee',
				tcol1='color:#eee',
				tcol2='color:#eee',
				tcol3='color:#333'
			var slong=800//480//960
			var sshort=480//320//540
			var size=Math.min(slong/8.1,sshort/8.1)
			
			
			sheet.new('body',
				'background-color:#111',
				'font-size:'+size*0.7+'px',
				'margin:0px'	
			)
			
			sheet.new('.game',
				'width:'+sshort+'px',
				'height:'+slong+'px',
				'max-height:'+slong+'px',
				'background-color:#333'
			)			
			sheet.new('.game.vert',
				'width:'+slong+'px',
				'height:'+sshort+'px',
				'max-height:'+sshort+'px',
				'background-color:#333'
			)
			sheet.new('table',
				'border-collapse:collapse'
			)
			
			sheet.new('table td',
				'padding:0px',
				'margin:0px',
				'border:1px solid #aaa'
			)
			sheet.new('body,button,input,table,select',
				'font-family:Open Sans Condensed, sans-serif',
				'font-weight: bold',
				'color:#333',
				'border:none',
				'text-transform: uppercase',
				'font-size:'+size*0.7+'px'
			)
			sheet.new('*',
				'box-sizing:border-box'
			)
			sheet.new('.hand',
				'cursor:pointer'
			)
			sheet.new('.sec,.form',
				'border:1px solid #aaa',
				'background-color: #eee'
			)
			sheet.new('.cols',
				'display:table',
				'table-layout:fixed',
				'width:100%'				
			)
			sheet.new('.cols>*',
				'display:table-cell',
				'vertical-align:top'
			)
			sheet.new('.rows',
				'display:table',
				'table-layout:fixed',
				'height:100%'				
			)
			sheet.new('.rows>*',
				'display:table-row'				
			)			
			sheet.new('.iblocks > *',
				'display:inline-block',
				'box-sizing:border-box'				
			)			
			sheet.new('.but',				
				'width:'+size+'px',				
				'height:'+size+'px',
				'line-height:'+size+'px',
				'border:1px solid #aaa',
				'cursor:pointer'				
			)
			sheet.new('.hig',
				'height:'+Math.floor(sshort/8)+'px',
				'line-height:'+Math.floor(sshort/9)+'px',								
				'background-color:#fff'
			)		
			sheet.new('.game.vert .hig4',
				'height:'+Math.floor(sshort/2)+'px'
			)			
			sheet.new('.hig4',
				'height:'+Math.floor(size*6)+'px'
			)		
			sheet.new('.wid',
				'width:'+Math.floor(sshort/8)+'px'
			)		
			sheet.new('.wid2',
				'width:'+Math.floor(sshort/4)+'px'
			)		
			
			sheet.new('.col1 .but',
				'background-color:#CAE78F'
			)
			sheet.new('.col2 .but',
				'background-color:#FFE4B3'
			)
			sheet.new('.col1 .selected',
				'background-color:yellowgreen'
			)			
			sheet.new('.col2 .selected',
				'background-color:orange'
			)			
			sheet.new('.ro',
				'border-radius:10px'
			)
			sheet.new('.iblock',
				'display:inline-block'
			)					
			sheet.new('.bo',
				'border:1px solid #aaa'
			)
			sheet.new('.tleft',
				'text-align:left'
			)
			sheet.new('.tright',
				'text-align:right'
			)
			sheet.new('.tmid',
				'text-align:center'
			)
			sheet.new('.bo',
				'border:1px solid #aaa'
			)
			sheet.new('.bt',
				'border-top:1px solid #aaa'
			)
			sheet.new('.bb',
				'border-bottom:1px solid #aaa'
			)
			sheet.new('.bl',
				'border-left:1px solid #aaa'
			)
			sheet.new('.br',
				'border-right:1px solid #aaa'
			)
			sheet.new('.gametime',
				'background-color:yellowgreen'
			)			
			sheet.new('.gametime.pause',
				'background-color:orange'
			)
			sheet.show()
			return sheet
		},
		show:function(){
			var game=d.body.r('div class=game tmid rows'),
				top=game.r('div class=top'),
				mid=game.r('div class=mid')
					.s('height:100%'),
				bot=game.r('div class=bot')				
			
			function confirmaction(){
				if(basket.pl!=-1 && basket.act!=-1){
					var act={
						pl:basket.pl,
						act:basket.act,
						col:basket.col,
						team:basket.team
					}
					basket.acts.push(act)
					basket.updateacts()
				}
			}
			
			function drawteams(){
				//teams
				var teams=d.r('div class=teams cols')
				teams.r('div class=team1 bo ro hand hig')
					.h('team:0')
					.s('background-color:yellowgreen')
					.on('click',function(e){
						game.remclass('col2')
						game.addclass('col1')
						basket.col='#CAE78F'
						basket.pl=-1
						basket.act=-1
						basket.team=1
						var ele=game.find('.actions .selected')
						if(ele){
							ele.remclass('selected')
						}						
						ele=game.find('.players .selected')
						if(ele){
							ele.remclass('selected')						
						}				
					})
				teams.r('div class=manageteams bo ro hand hig wid title=menu')
					.h('...')					
					.on('click',function(e){
						if(game.hasclass('vert')){
							game.remclass('vert')
						} else {
							game.addclass('vert')
						}
					})
				teams.r('div class=team2 bo ro hand hig')
					.h('team:0')
					.s('background-color:orange')
					.on('click',function(e){
						game.remclass('col1')
						game.addclass('col2')
						basket.col='#FFE4B3'
						basket.pl=-1
						basket.act=-1
						basket.team=2
						var ele=game.find('.actions .selected')
						if(ele){
							ele.remclass('selected')
						}						
						ele=game.find('.players .selected')
						if(ele){
							ele.remclass('selected')						
						}
						
					})
					
				return teams
			}			
			function drawplayers(){
				var pls=d.r('div class=players iblocks'),
					pl
				loop(12,function(i2){
					pl=pls.r('div class=player but bo hand ro')
						.h(i2+4)
						.on('click',function(e){
							var sel=game.find('.players .selected')
							if(sel){
								sel.remclass('selected')
							}
							e.target.addclass('selected')
							basket.pl=e.target.h()
							basket.act=-1
							var ele=game.find('.actions .selected')
							if(ele){
								ele.remclass('selected')
							}						
							//confirmaction()
						})
					
				})
				return pls
			}
			function drawaction(){
				var acts=[						
						'1+',
						'1-',
						'2+',
						'2-',
						'3+',
						'3-',
						'fo',
						'tf',
						'tt',												
						'bl',
						'st',
						'as',
						'rb'
					],
					actions=d.r('div class=actions')						
										
				actlist=actions.r('div class=actionslist iblocks')				
				loop(acts,function(i,name){
					actlist.r('div class=action but ro')						
						.h(name)
						.on('click',function(e){
							var sel=game.find('.actions .selected')
							if(sel){
								sel.remclass('selected')
							}							
							e.target.addclass('selected')
							basket.act=e.target.h()
							confirmaction()
						})
				})
			
				return actions
			}
			function drawshooting(){
				//shootinpos
				var pos=d.r('div class=spos')
					.r('div class=toggle w100 bo ro')
						.h('mark shooting pos')
						.on('click',function(e){
							var court=bot.find('.court')
							if(court){
								c0.rem(court)
								//court.rem()
							} else {
								court=basket.showcourt(0.6)
								court.to(bot.find('.spos'))
								//court.s('zoom:0.5')
								var sspot=0,
									cc=c0.get(court)
								court.on('mousedown',function(e){									
									var bounds=court.getClientRects()[0],
										pos={
											x:e.pageX-bounds.left,
											y:e.pageY-bounds.top-d.body.scrollTop
										}					
									if(sspot){
										sspot.rem()
									}
									sspot=cc.circ({
										x:pos.x,
										y:pos.y,
										rad:15,
										color:'yellowgreen'
									})
									sspot.to()									
									cc.redraw()
								})								
							}
						}).p	
				return pos
			}
			//drawshooting().to(bot)
			drawaction().to(bot)
			drawplayers().to(bot)			
			drawteams().to(bot)
			
			//gamelines				
			var gamelines=mid.r('div class=gamelines bo hig4')
					.s('overflow:auto')
			var table=gamelines.r('table')
					.s('width:100% margin-bottom: 1px')
				,
				thead=table.r('thead'),
				tbody=table.r('tbody'),
				tfoot=table.r('tfoot'),
				tr,
				td,
				fields=[
					'nr',
					'name',
					'action',
					'time',
					'rem'
				]
											
			basket.updateacts=function(){
				tbody.h('')
				var score1=0,
					score2=0,
					val
				loop(basket.acts,function(i,act){
					tr=tbody.r('tr class=hig tmid')
						.s('background-color:'+act.col)
					tr.r('td')
						.h(act.pl)
					tr.r('td')
						.h(act.act)
					tr.r('td')
						.h(d.find('.gametime').h())
					tr.r('td')
						.h(d.find('.quarter').h())						
					tr.r('td class=wid')
						.h('X')
					
					if(act.act.indexOf('+')!=-1){						
						val=parseInt(act.act.replace('+',''))
						if(act.team==1){							
							score1+=val
						} else if(act.team==2){
							score2+=val
						}
					}					
				})
				console.log('val:',score1)
				d.find('.team1').h('team:'+score1)
				d.find('.team2').h('team:'+score2)
				gamelines.scrollTop=99999999
			}
			
			function drawtime(){
				//time
				var time=d.r('div class=time cols'),
					quarter=time.r('div class=quarter big bo ro hand hig wid'),
					gtime=time.r('div class=gametime big bo ro hand pause hig'),
					otime=time.r('div class=offencetime big bo ro hand hig wid2'),
					o14=time.r('div class=o14 big bo ro hand hig wid')
					
				quarter.h('Q1')
					.on('click',function(e){
						basket.gtime=basket.dgtime
						basket.quarter=(basket.quarter%4)+1
						basket.updtime()
					})					
				gtime.h('')					
					.on('click',function(e){
						if(basket.pause){
							basket.start()
						} else {
							basket.stop()
						}
					})	
				
				otime.h('')					
					.on('click',function(e){
						basket.otime=basket.dotime
						basket.stop()
						basket.updtime()
					})						
				o14.h('14')					
					.on('click',function(e){
						basket.otime=basket.sotime
						basket.stop()
						basket.updtime()						
					})											
				return time
			}
			drawtime().to(top)
			d.find('.team1').trigger('click')
		},
		showcourt:function(scale){		
			scale=scale || 1
			var canvas=d.r('canvas class=court')
			canvas.set('width',(780*scale)+'px')
			canvas.set('height',(550*scale)+'px')
			
			var c=c0.add(canvas)
			var court=c.rect({
				name:'court',
				x:390*scale,
				y:275*scale,	
				wid:750*scale,
				hig:550*scale,
				color:'#eee',
				linecolor:'#aaa',
				linewid:2
			})
			court.to()

			var three=c.circ({
				name:'three',
				x:390*scale,
				y:80*scale,	
				rad:320*scale,
				color:'#eee',
				linecolor:'#aaa',
				linewid:2
			})
			three.to()
			
			var paint=c.rect({
				name:'paint',
				x:390*scale,
				y:145*scale,	
				wid:245*scale,
				hig:290*scale,
				color:'#eee',
				linecolor:'#aaa',
				linewid:2
			})
			paint.to()
			
			var free=c.circ({
				name:'free',
				x:390*scale,
				y:290*scale,	
				rad:95*scale,
				//color:'#eee',
				linecolor:'#aaa',
				linewid:2
			})
			free.to()				
			
			var board=c.rect({
				name:'board',
				x:390*scale,
				y:60*scale,	
				wid:90*scale,
				hig:2,
				color:'#eee',
				linecolor:'#aaa',
				linewid:2
			})
			board.to()				
			
			var rim=c.circ({
				name:'rim',
				x:390*scale,
				y:80*scale,	
				rad:15*scale,
				//color:'#eee',
				linecolor:'#aaa',
				linewid:2
			})
			rim.to()					
			
			//draw curve
			/*
			var curve=c.curve({
				p1:{x:70,y:0},
				p2:{x:710,y:0},
				c1:{x:70,y:530},
				c2:{x:710,y:530},
				color:'blue',
				linewid:2
			})
			curve.to()			
			*/
			c.redraw()		
		
			return canvas
		},
		updtime:function(){
			if(basket.gtime<=0){
				basket.gtime=basket.dgtime
			}
			if(basket.otime<=0){
				basket.otime=basket.dotime
			}		
			var gtime=d.find('.gametime'),
				otime=d.find('.offencetime'),
				quarter=d.find('.quarter')
			
			function fgtime(time){
				var min=Math.floor((time/(1000*60*60))),
					sec=Math.floor(((time/(1000))%60)),
					msec=Math.floor(((time/(100))%10))
				if(min<10){
					min=['0',min].join('')
				}
				if(sec<10){
					sec=['0',sec].join('')
				}			
				var ft=[min,sec,msec].join(':')
				return ft
			}
			function fotime(time){
				var sec=Math.floor(((time/(1000))%60)),
					msec=Math.floor(((time/(100))%10))
				if(sec<10){
					sec=['0',sec].join('')
				}			
				var ft=[sec,msec].join(':')
				return ft
			}			
			gtime.h(fgtime(basket.gtime))
			otime.h(fotime(basket.otime))
			quarter.h('Q'+basket.quarter)
		},
		start:function(){
			if(basket.gtime<=0){
				basket.gtime=basket.dgtime
			}
			if(basket.otime<=0){
				basket.otime=basket.dotime
			}
			basket.lt=new Date().getTime()
			basket.pause=false
			d.find('.gametime').remclass('pause')
		},
		stop:function(){
			basket.pause=true
			d.find('.gametime').addclass('pause')
		},
		pause:true,
		run:function(){
			basket.ct=new Date().getTime()
			basket.dt=basket.ct-basket.lt
			basket.lt=basket.ct
			if(!basket.pause){
				basket.gtime-=basket.dt
				basket.otime-=basket.dt
				if(basket.otime<=0){
					basket.stop()
					basket.otime=basket.dotime
				}
				if(basket.gtime<=0){
					basket.stop()
					basket.gtime=basket.dgtime					
					basket.quarter=(basket.quarter%4)+1
				}
				
				basket.updtime()				
			}
			setTimeout(basket.run,10)
		}
	}
	basket.sheet=basket.setstyles()
	basket.show()
	basket.run()
	basket.updtime()
	basket.updateacts()
})

</script>