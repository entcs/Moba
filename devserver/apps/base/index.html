<body><h1>BASE</h1><a href='/'>home</a></body>
<script src='https://rawgithub.com/entcs/Moba/master/Dom0/dom0.js'></script>
<style>
.selected {
	color:green;	
	background:lightgreen;
}
.section {
	border:1px solid #aaa;
	padding:10px;
}
table {
	border-collapse:collapse;
	width:100%;
	background-color:#eee;
}
input{
	background-color:#fff;
	text-align:right;
}
table td {
	border:1px solid #aaa;	
}
.cols {
	display:table;
	width:100%;
}
.cols > *{
	display:table-cell;
}
button {
	color:#666;
	cursor:pointer;
	border:2px solid #aaa;	
	background-color:#eee;
}
button:hover{
	background:lightgreen;
}
.iblocks > * {
	display:inline-block;
}
</style>
<script>
function nicejson(json){
	if(typeof(json)=='string'){
		json=JSON.parse(json)
	}
	function maketab(nr){
		console.log('maketab:',typeof(nr),nr)
		var str='    ',
		tab=''
		loop(nr,function(i){
			tab+=str
		})
		return tab
	}
	function recu(obj,str,tab){
		tab=tab || 0
		str=str || ''
		if(obj){
			var list=[]
			//console.log('obj:',obj,'str:',str)
			if(typeof(obj)=='object'){						
				//str+='\n'			
				tab+=1
				if(obj.length==undefined){								
					list=[]
					loop(obj,function(k,v){					
						list.push(maketab(tab)+k+':'+recu(v,str,tab))
					})							
					str+='{\n'+list.join(',\n')+'\n'+maketab(tab-1)+'}'
				} else {
					list=[]
					loop(obj,function(k,v){					
						list.push(maketab(tab)+recu(v,str,tab))
					})
					str+='[\n'+list.join(',\n')+'\n'+maketab(tab-1)+']'
				}			
				tab-=1
			} else {
				str=obj
			}		
		} else {
			str=''
		}
		return str
	}
	var res=recu(json)	
	console.log(res)
	return res
}
var obj={
	name:{
		v1:1,
		v2:'2',
		v3:[1,2,3],
		v4:{
			a:1,
			a:2
		}
	}
}
nicejson(obj)
d.on('ready',function(e){
	console.log('ready')
	
	var base={		
		html:'',
		bases:[],
		selected:'',
		tables:[],
		schemafields:['Field','Type','Null','Key','Default','Extra'],
		show:function(){
			base.html=d.body.r('div class=base')
			var bases=base.html.r('div class=bases section')
				
			bases.r('div class=list section')
			bases.r('div class=controls')
				.r('input').p
				.r('button class=add html=add new database')
					.on('click',function(e){
						var inp=d.find('.bases .controls input')
							data={
							base:inp.value,
							columns:base.gettableschema()
						}
						inp.value=''
						if(data.base){
							d.send('bases/add',data,function(res){
								console.log('res:',res)
								var data=JSON.parse(res)					
								base.bases=data.bases
								base.selected=data.selected
								base.tables=data.tables
								
								base.showbases()
								base.showschema([])								
							},'json')						
						}
					}).p
				.r('button class=rem html=drop database')
					.on('click',function(e){
						var data={
							base:d.find('.bases .list .selected').h()							
						}
						d.send('bases/rem',data,function(res){
							console.log('res:',res)
							var data=JSON.parse(res)					
							base.bases=data.bases
							base.selected=data.selected
							base.tables=data.tables
							
							base.showbases()
							base.showschema([])								
							
						},'json')						
					})
							
			var tables=base.html.r('div class=tables section')			
			tables.r('div class=existing')
				.r('div class=list section').p
				.r('div class=controls iblocks')
					.r('input').p
					.r('button class=add html=add new table')
						.on('click',function(e){
							var inp=d.find('.tables .controls input'),
								data={
								table:inp.value,
								columns:base.gettableschema()
							}
							inp.value=''
							d.send('tables/add',data,function(res){
								console.log('res:',res)
							},'json')							
						}).p						
					.r('button class=save html=save changes to table')
						.on('click',function(e){
							var data={
								table:d.find('.existing .list .selected').h(),
								columns:base.gettableschema()
							}
							d.send('tables/set',data,function(res){
								console.log('res:',res)
							},'json')							
						}).p
					.r('button class=droptable html=drop table')
						.on('click',function(e){
							var data={
								table:d.find('.existing .list .selected').h()
							}
							if(data.table){
								d.send('tables/rem',data,function(res){
									console.log('res:',res)
								},'json')	
							}
						}).p
				.r('div class=schema section')
			var tabledata=tables.r('div class=tabledata')
			tabledata.r('button html=get table data')
				.on('click',function(e){
					var url='base/tables/tabledata?table='+d.find('.existing .list .selected').h()
					d.send(url,function(res){
						console.log('data list:',res)
						base.showtabledata(res)
					})
				})
			tabledata.r('div class=result')
			
			//custom query
			base.html.r('div class=customquery section')
				.r('div html=custom query').p
				.r('textarea class=query')
					.s('width:100% display:block resize:vertical')
					.on('keydown',function(e){
						if(e.which==13){
							d.find('.sendquery').trigger('click')							
						}
					}).p
				.r('button class=sendquery html=send query')
					.on('click',function(e){
						var ta=d.find('.query')
						d.send('bases/query?query='+ta.value,function(res){
							var nice=nicejson(res),
								breaks=nice.split('\n').length							
							d.find('.queryres').value=nice
							d.find('.queryres').set('rows',breaks)
						})
					}).p
				.r('textarea class=queryres')
					.s('width:100% display:block resize:vertical')				
		},
		showbases:function(){				
				var bases=base.html.find('.bases .list')
				bases.h('')
				bases.r('div html=bases')
				loop(base.bases,function(i,item){								
					var but=bases.r('button')
						.h(item.Database)
						.on('click',function(e){
							var tar=e.target
							d.send('bases/use?base='+item.Database,function(res){
								var act=tar.p.find('.selected')
								if(act) act.remclass('selected')
								tar.addclass('selected')
								
								var data=JSON.parse(res)
								base.selected=data.selected
								base.tables=data.tables								
								base.showtables()								
								base.showschema([])
							})
						})
						
					if(item.selected) {
						bases.selected=item.Database
						but.addclass('selected')					
					}
				})
				base.showtables()
		},
		showtables:function(){
			var list=base.html.find('.tables .existing .list')
			list.h('')
			d.find('.tables .existing .schema').h('')							
			loop(base.tables,function(i,item){
				loop(item,function(k,v){
					list.r('button')
						.h(v)
						//.s('display:block')
						.on('click',function(e){
							var tar=e.target,
								act=tar.p.find('.selected')
							if(act){
								act.remclass('selected')
							}
							tar.addclass('selected')							
							console.log('get schema')
							d.send('tables/get?table='+v,function(res){
								var data=JSON.parse(res)
								base.showschema(data)
							})
						})
				})
			})				
		},
		showschema:function(data){
			var table=d.r('table'),
				thead=table.r('thead'),
				tbody=table.r('tbody'),
				tfoot=table.r('tfoot'),
				tr=thead.r('tr'),
				td
				
			
			table.s('table-layout:fixed')
			
			loop(base.schemafields,function(i,name){
				
				td=tr.r('td class='+name)
					.h(name)
			})
			tr.r('td')
				.s('width:27px')
				
			function addrow(data){
				var tr=tbody.r('tr')				
				loop(base.schemafields,function(i,name){					
					td=tr.r('td')
					td.r('input')
						.s('width:100%')
				})
				tr.r('td')						
					.s('background-color:#fff')
					.r('button html=X')
					.on('click',function(e){
						var tar=e.target,
							tr=tar.findup('tr')
						
						tar.findup('tr').rem()	
					})					
				
			}
			if(data){
				var inp
				loop(data,function(i,item){
					var tr=tbody.r('tr')
					console.log('item:',item)
					loop(item,function(k,v){
						td=tr.r('td')
						inp=td.r('input disabled')
							.s('width:100%')
						inp.val=v						
						if(k=='Field' || k=='Type' || k=='Extra'){
							inp.set(disabled)
						}
							
					})
					td=tr.r('td')						
						.s('background-color:#fff width:1px')
						.r('button html=X')
						.on('click',function(e){
							var tar=e.target,
								tr=tar.findup('tr')
							
							tar.findup('tr').rem()							
						})
				})
			}
			tfoot.r('tr')
				.r('td colspan=7')
					.s('background-color:#fff')
					.r('button html=add new field')
						.s('width:100%')
						.on('click',function(e){
							addrow()
						})
									
			var cont=d.find('.tables .existing .schema')
			cont.h('')
			table.to(cont)			
		},
		getbases:function(){
			d.send('bases/list',function(res){
				var data=JSON.parse(res)					
				base.bases=data.bases
				base.selected=data.selected
				base.tables=data.tables
				
				base.showbases()
				base.showschema([])
			})		
		},
		gettableschema:function(){
			var data=[],
				rows=d.findall('.schema table tbody tr'),
				item={}			
			loop(rows,function(i1,row){				
				item={}
				loop(base.schemafields,function(i2,name){
					item[name]=row.children[i2].find('input').value
				})
				data.push(item)
			})			
			return data
		},
		showtabledata:function(data){
			data=JSON.parse(data)
			var cont=d.find('.tabledata .result')				
			cont.h('')
			var table=d.r('table'),
				thead=table.r('thead'),
				tbody=table.r('tbody'),
				row
			
			loop(data,function(i,line){
				if(!i){
					row=thead.r('tr')
					loop(line,function(k,v){
						row.r('td')
							.h(k)
					})
				}
				console.log('line:',line)
				row=tbody.r('tr')
				loop(line,function(k,v){
					row.r('td')
						.h(v)
				})
			})
			table.to(cont)
		}
	}
	base.show()
	base.getbases()
	
})
</script>