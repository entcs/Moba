<head>
	<link href='http://fonts.googleapis.com/css?family=Open+Sans+Condensed:700,300' rel='stylesheet' type='text/css'>
	<script src='https://rawgithub.com/entcs/Moba/master/Dom0/dom0.js'></script>
</head>
<body><h1>BASE</h1><a href='/'>home</a></body>
<script>

function nicejson(json){
	if(typeof(json)=='string'){
		json=JSON.parse(json)
	}
	function maketab(nr){
		console.log('maketab:',typeof(nr),nr)
		var str='    ',
		tab=''
		loop(nr,function(i){
			tab+=str
		})
		return tab
	}
	function recu(obj,str,tab){
		tab=tab || 0
		str=str || ''
		if(obj){
			var list=[]
			//console.log('obj:',obj,'str:',str)
			if(typeof(obj)=='object'){						
				//str+='\n'			
				tab+=1
				if(obj.length==undefined){								
					list=[]
					loop(obj,function(k,v){					
						list.push(maketab(tab)+k+':'+recu(v,str,tab))
					})							
					str+='{\n'+list.join(',\n')+'\n'+maketab(tab-1)+'}'
				} else {
					list=[]
					loop(obj,function(k,v){					
						list.push(maketab(tab)+recu(v,str,tab))
					})
					str+='[\n'+list.join(',\n')+'\n'+maketab(tab-1)+']'
				}			
				tab-=1
			} else {
				str=obj
			}		
		} else {
			str=''
		}
		return str
	}
	var res=recu(json)	
	console.log(res)
	return res
}
var base
d.on('ready',function(e){
	console.log('ready')	
	base={		
		html:'',
		bases:[],
		selected:'',
		tablename:'',
		tables:[],
		schemafields:['Field','Type','Null','Key','Default','Extra'],
		setstyles:function(){
			var sheet=d.dss.new('basesheet')
			sheet.new('body',
				'background-color: #ccc'
			)
			sheet.new('body,button,input,table',
				'font-family:Open Sans Condensed, sans-serif',
				'font-weight: bold',
				'color:#666',
				'text-transform: uppercase'
			)
			sheet.new('.section',
				'border:1px solid #aaa',
				'padding:3px',
				'margin-top: 20px',
				'background: #eee'			
			)
			sheet.new('table',
				'border-collapse:collapse',
				'width:100%',
				'background-color:#eee'
			)
			sheet.new('input',
				'text-align:right'
			)
			sheet.new('table td',
				'border:1px solid #aaa'
			)
			sheet.new('.cols',
				'display:table',
				'width:100%'
			)
			sheet.new('.cols > *',
				'display:table-cell'
			)
			sheet.new('button',
				'color:#666',
				'cursor:pointer',				
				'border:2px solid #aaa',
				'background-color:#eee'
			)
			sheet.new('button:hover',
				'background:lightgreen'
			)
			sheet.new('.iblocks > *',
				'display:inline-block'
			)
			sheet.new('.group',
				'display:inline-block',
				'border:1px solid #aaa',
				'background-color: #ccc',
				'padding:3px',
				'margin:3px'
			)
			sheet.new('.selected',
				'color:green',
				'background:lightgreen'
			)
			
			
			sheet.show()
			this.sheet=sheet
		},
		show:function(){
			base.html=d.body.r('div class=base')
			var bases=base.html.r('div class=bases section')
				
			bases.r('div class=list')
			bases.r('div class=controls')
				.r('input').p
				.r('button class=add html=add new database')
					.on('click',function(e){
						var inp=d.find('.bases .controls input')
							data={
							base:inp.value,
							columns:base.gettableschema()
						}
						inp.value=''
						if(data.base){
							d.send('bases/add',data,function(res){
								console.log('res:',res)
								var data=JSON.parse(res)					
								base.bases=data.bases
								base.selected=data.selected
								base.tables=data.tables
								
								base.showbases()
								//base.showschema([])								
							},'json')						
						}
					}).p
				.r('button class=rem html=drop database')
					.on('click',function(e){
						var data={
							base:d.find('.bases .list .selected').h()							
						}
						d.send('bases/rem',data,function(res){
							console.log('res:',res)
							var data=JSON.parse(res)					
							base.bases=data.bases
							base.selected=data.selected
							base.tables=data.tables
							
							base.showbases()
							//base.showschema([])								
							
						},'json')						
					})
			
			var tables=base.html.r('div class=tables section')			
				
			tables.r('div class=controls iblocks')
					.r('input').p
					.r('button class=add html=add new table')
						.on('click',function(e){
							var inp=d.find('.tables .controls input'),
								data={
								table:inp.value,
								columns:base.gettableschema()
							}
							inp.value=''
							d.send('tables/add',data,function(res){
								console.log('res:',res)
							},'json')							
						}).p
					.r('button class=save html=save changes to table')
						.on('click',function(e){
							var data={
								table:d.find('.existing .list .selected').h(),
								columns:base.gettableschema()
							}
							d.send('tables/set',data,function(res){
								console.log('res:',res)
							},'json')							
						}).p
					.r('button class=droptable html=drop table')
						.on('click',function(e){
							var data={
								table:d.find('.existing .list .selected').h()
							}
							if(data.table){
								d.send('tables/rem',data,function(res){
									console.log('res:',res)
								},'json')	
							}
						}).p.p
						
			tables.r('div class=existing')
				.r('div html=tables').p
				.r('div class=list')
			tables.r('div class=conthead html=result').p
			tables.r('div class=cont group').p
						
			//custom query
			base.html.r('div class=customquery section')
				.r('div html=custom query').p
				.r('textarea class=query')
					.s('width:100% display:block resize:vertical')
					.on('keydown',function(e){
						if(e.which==13){
							d.find('.sendquery').trigger('click')							
						}
					}).p
				.r('button class=sendquery html=send query')
					.on('click',function(e){
						var ta=d.find('.query')
						d.send('bases/query?query='+ta.value,function(res){
							var nice=nicejson(res),
								breaks=nice.split('\n').length							
							d.find('.queryres').value=nice
							d.find('.queryres').set('rows',breaks)
						})
					}).p
				.r('textarea class=queryres')
					.s('width:100% display:block resize:vertical')				
		},
		showbases:function(){				
				var bases=base.html.find('.bases .list')
				bases.h('')
				bases.r('div html=bases')
				loop(base.bases,function(i,item){								
					var but=bases.r('button')
						.h(item.Database)
						.on('click',function(e){
							var tar=e.target
							d.send('bases/use?base='+item.Database,function(res){
								var act=tar.p.find('.selected')
								if(act) act.remclass('selected')
								tar.addclass('selected')
								
								var data=JSON.parse(res)
								base.selected=data.selected
								base.tables=data.tables								
								base.showtables()								
								//base.showschema([])
							})
						})
						
					if(item.selected) {
						bases.selected=item.Database
						but.addclass('selected')					
					}
				})
				base.showtables()
		},
		showtables:function(){
			var list=base.html.find('.tables .existing .list')
			list.h('')			
			loop(base.tables,function(i,item){
				loop(item,function(k,v){
					list.r('div class=group')
						.s('display:inline-block')
						.r('div')
							.h(v).p
						.r('button')
							.s('display:block width: 100%')
							.h('show schema')
							.on('click',function(e){
								var tar=e.target,
									act=tar.p.p.find('.selected')
								if(act){
									act.remclass('selected')
								}
								tar.p.addclass('selected')
								base.tablename=v
								
								d.send('tables/get?table='+v,function(res){
									if(res){
										d.find('.conthead').h(v+' schema')
										var data=JSON.parse(res)
										base.showschema(data)
									}
								})
							}).p
						.r('button')
							.s('display:block width: 100%')
							.h('show items')
							.on('click',function(e){
								var tar=e.target,
									act=tar.p.p.find('.selected')
								if(act){
									act.remclass('selected')
								}
								tar.p.addclass('selected')
								base.tablename=v
								
								url='items/list?tablename='+v						
								d.send(url,function(res){
									d.find('.conthead').h(v+' items')									
									base.showitems(res)
								})								
							})							
				})
			})				
		},
		showschema:function(data){
			var table=d.r('table'),
				thead=table.r('thead'),
				tbody=table.r('tbody'),
				tfoot=table.r('tfoot'),
				tr=thead.r('tr'),
				td
				
			
			//table.s('table-layout:fixed')
			
			loop(base.schemafields,function(i,name){				
				td=tr.r('td class='+name)
					.h(name)
				if(name=='Key'){
					td.s('width:48px')
				}					
			})
			tr.r('td')
				.s('width:27px')
				
			function addrow(data){
				var tr=tbody.r('tr')				
				loop(base.schemafields,function(i,name){					
					td=tr.r('td')
					td.r('input')
						.s('width:100%')
				})
				tr.r('td')						
					.s('background-color:#fff')
					.r('button html=X')
					.on('click',function(e){
						var tar=e.target,
							tr=tar.findup('tr')
						
						tar.findup('tr').rem()	
					})					
				
			}
			if(data){
				var inp
				loop(data,function(i,item){
					var tr=tbody.r('tr')
					console.log('item:',item)
					loop(item,function(k,v){
						td=tr.r('td')
						inp=td.r('input')
							.s('width:100%')									
						
						if(k=='Key'){
							inp.set('disabled',true)
						} else if(k=='Null'){
							v=(v=='NO'? 'NOT NULL' : '')
						} else if(k=='Default'){
							v=(v ? 'DEFAULT '+v : '')
						}
						
						inp.val=v
					})
					td=tr.r('td')						
						.s('background-color:#fff width:1px')
						.r('button html=X')
						.on('click',function(e){
							var tar=e.target,
								tr=tar.findup('tr')
							
							tar.findup('tr').rem()							
						})
				})
			}
			tfoot.r('tr')
				.r('td colspan=7')
					.s('background-color:#fff')
					.r('button html=add new field')
						.s('width:100%')
						.on('click',function(e){
							addrow()
						})
									
			var cont=d.find('.cont')
			cont.h('')
			table.to(cont)			
		},
		showitems:function(data){
			data=JSON.parse(data)
			var cont=d.find('.cont')				
			cont.h('')
			var table=d.r('table'),
				thead=table.r('thead'),
				tbody=table.r('tbody'),
				row,
				addrow,
				types={},
				type,
				inp
			
			//render headers
			row=thead.r('tr')
			loop(data.schema,function(k,v){
				types[v.Field]=v.Type					
				row.r('td')
					.h(v.Field)
					.set('data-type',v.Type)
			})
			row.r('td')
			
			//render items
			loop(data.list,function(i,line){				
				row=tbody.r('tr')
				row.item=line
				loop(line,function(k,v){
					type=types[k]
					inp=row.r('td')
						.r('input')
							.set('data-type',type)
							.s('width:100%')
					if(type.indexOf('int')!=-1){
						//inp.set('type','number')
					} else if(type=='date'){
						if(v){
							//format date
							v=v.split('T')[0].split('-').join('.')
						}
					}
					inp.id=k
					inp.val=v

				})
				//controls
				row.r('td')
					.s('width:1px white-space:nowrap')
					.r('button class=set html=set')
						.on('click',function(e){							
							var data={
								item:this.findup('tr').getform(),
								tablename:base.tablename
							}
							d.send('items/set',data,function(res){
								console.log('res:',res)
							},'json')
						})						
						.p
					.r('button class=rem html=rem')
						.on('click',function(e){
							/*
							var data={
								id:this.findup('tr').item.Id,
								tablename:base.tablename
							}
							d.send('items/rem',data,function(res){
								console.log('res:',res)
							},'json')
							/**/
						})						
						.p					
			})
			//add new row
			if(data.list.length){
				row=tbody.r('tr')
				loop(data.list[0],function(k,v){
					inp=row.r('td')
						.r('input')
							.s('width:100%')
					inp.id=k
					inp.val=''
				})	
				//controls
				row.r('td')
					.s('width:1px white-space:nowrap')
					.r('button class=add html=add')
						.s('width:100%')
						.on('click',function(e){
							var fdata=this.findup('tr').getform(),
								id=fdata.id
							delete fdata.id
							
							var data={
								item:fdata,
								id:id,
								tablename:base.tablename,
								want:'list'
							}
							d.send('items/add',data,function(res){
								console.log('res:',res)
								base.showitems(res)
							},'json')							
						})
			}
			table.to(cont)
		},		
		getbases:function(){
			d.send('bases/list',function(res){
				var data=JSON.parse(res)					
				base.bases=data.bases
				base.selected=data.selected
				base.tables=data.tables
				
				base.showbases()
				//base.showschema([])
			})		
		},
		gettableschema:function(){
			var data=[],
				rows=d.findall('.schema table tbody tr'),
				item={}			
			loop(rows,function(i1,row){				
				item={}
				loop(base.schemafields,function(i2,name){
					item[name]=row.children[i2].find('input').value
				})
				data.push(item)
			})			
			return data
		},
	}
	base.setstyles()
	base.show()
	base.getbases()
	
})
</script>