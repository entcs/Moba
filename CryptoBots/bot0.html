<link rel="preconnect" href="https://fonts.gstatic.com">
<link href="https://fonts.googleapis.com/css2?family=Open+Sans+Condensed:wght@300;700&display=swap" rel="stylesheet">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<style>
	body,
	table,
	button {
		font-family: 'Open Sans Condensed', sans-serif;
		font-weight: bold;
	}
	.green {
		color: rgb(72, 112, 8);
	}
	.red {
		color: rgb(139, 68, 21);
	}
</style>
<body>
	<p>Select local CSV File:</p>
	<input id="csv" type="file">
	<input id="sellstep" value=1 />
	<button id="runsnake">RUNSNAKE</button>
	<button id="rundca">RUNDCA</button>
	<table>
		<thead>
			<tr>
				<td>ACTION</td>
				<td>PRICE</td>
				<td>PROFIT</td>
				<td>TOTAL PROFIT</td>
				<td>FEE</td>
				<td>TOTAL FEES</td>
				<td>USD</td>
			</tr>
		</thead>
		<tbody class='history'>
		</tbody>
	</table>
</body>
<script>	
	$('#csv').on('change', function(e){
        var reader = new FileReader()
        reader.onload = function () {
			var csvdata = reader.result
			var rows = csvdata.split('\n'),
				rd
			DATA = []
			loop(rows,function(i,r){
				rd = r.split(',')
				if(i>1) DATA.push(rd)
			})
			DATA = DATA.reverse()
			console.log('have data', DATA.length)
        }
        reader.readAsBinaryString(e.target.files[0])
	})

	var PRICE = 0,
		SOLD = 0,
		PROFIT = 0,
		FEECOUNT = 0,
		FEEAMOUNT = 0
	var loop=function(obj,fn){
		if(obj){
			if(fn===undefined){
				var count=0
				while(obj(count)!==false) count+=1
			} else if(typeof(obj)=='number'){
				for(var nr=0;nr<obj;nr++) if(fn(nr)===false) break
			} else if(obj.length){
				for(var nr=0;nr<obj.length;nr++) if(obj.hasOwnProperty(nr)) if(fn(nr,obj[nr])===false) break
			} else {
				for(var key in obj) if(fn(key,obj[key])===false) break
			}
		}
	}
	var bot = {
		sellorders: [],
		dcasellorder: '',
		sellstep: 1,
		buystep: 1,
		averageprice: 0,
		steps: 10,
		volume: 10,
		helpneck: 50,
		dosnake: function(){					
			this.getprice()		
			if(PRICE){			
				var order = this.sellorders[this.sellorders.length - 1],
					sellprice = 0,
					buyprice = 0
				if(order){
					sellprice = order.price * (100+this.sellstep)/100
					buyprice = order.price * (100-this.buystep)/100
				}
				if(!this.sellorders.length || (order && PRICE <= buyprice)){
					if(USD > this.volume){
						this.buy({
							price: buyprice || PRICE,
							volume: this.volume
						})
					}
				} else if(PRICE >= sellprice) {						
					//sell
					this.sell(sellprice)
				}	
			}				
		},
		dodca: function(){
			this.getprice()		
			if(PRICE){			
				var order = this.dcasellorder,
					sellprice = 0,
					buyprice = 0
				if(order){
					sellprice = order.price * (100+this.sellstep)/100
					buyprice = order.price * (100-this.buystep)/100
				}
				if(!order || (order && PRICE <= buyprice)){
					if(USD > this.volume){
						this.buydca({
							price: buyprice || PRICE,
							volume: this.volume
						})
					}
				} else if(PRICE >= sellprice) {						
					//sell
					this.selldca(sellprice)
				}	
			}	
		},
		getprice: function(){
			PRICE = parseFloat(DATA[INDEX][6])
			return PRICE
		},
		buy: function(conf){
			var order = {
				price: conf.price,
				volume: conf.volume,
				time: new Date().getTime(),
				bot: this
			}		
			order.volume = this.volume/order.price					
			USD -= this.volume
			ADA += order.volume

			this.sellorders.push(order)
			if(this.sellorders.length > MAXSO) MAXSO = this.sellorders.length
			return order			
		},
		sell: function(sellprice){					
			var order = this.sellorders.pop(),
				ordertotal = order.volume * order.price,
				total = order.volume * sellprice

			/**/
			//subtract fee 0.1% in binance			
			var fee = total * 0.001//0.001
			total -= fee
			FEEAMOUNT += fee

			USD += total
			ADA -= order.volume		
			var profit = total - ordertotal
			PROFIT += profit
			SOLD += 1
		},
		buydca: function(conf){
			var ordervolume = conf.volume/conf.price
			if(!this.dcasellorder){
				this.dcasellorder = {
					price: conf.price,
					volume: ordervolume
				}	
			}
			var avgprice = (this.dcasellorder.price * this.dcasellorder.volume + conf.volume) / (this.dcasellorder.volume + ordervolume)
			this.dcasellorder.volume += ordervolume

			USD -= conf.volume
			ADA += ordervolume
			
			this.dcabuycount+=1
		},
		selldca: function(sellprice){
			var order = this.dcasellorder,					
				ordertotal = order.volume * order.price,
				total = order.volume * sellprice

			/**/
			//subtract fee 0.1% in binance			
			var fee = total * 0.001//0.001
			total -= fee
			FEEAMOUNT += fee

			USD += total
			ADA -= order.volume		
			var profit = total - ordertotal
			PROFIT += profit
			SOLD += 1
			this.dcasellorder = ''
			this.dcabuycount = 0
		}
	}
	var STOP = false,		
		INDEX = 1,
		SOLD = 0
		PROFIT = 0
		FEECOUNT = 0
		FEEAMOUNT = 0,
		MAXSO = 0
		ADA = 0,
		USD = 1000,
		DATA = [
			[0,0,0,0,0,0,100],
			[0,0,0,0,0,0,101]
		]

	$('#runsnake').on('click', function(e){
		SOLD = 0
		PROFIT = 0
		FEECOUNT = 0
		FEEAMOUNT = 0
		MAXSO = 0
		ADA = 0
		USD = 1000		
		bot.sellstep = parseFloat($('#sellstep').val())
		bot.buystep = parseFloat($('#sellstep').val())		
		bot.sellorders = []		
		for(x=0;x<DATA.length;x++){
			INDEX = x
			if(STOP) return
			bot.dosnake()
			
		}
		//order value at market price
		var sovalue = 0
		loop(bot.sellorders, function(i,s){
			sovalue += s.volume * PRICE
		})
		console.log($('#sellstep').val(),'profit:', PROFIT, 'COUNT:',SOLD,'FEES:',FEEAMOUNT, USD,bot.sellorders.length,'SOV:',sovalue,'TOTAL:', USD+sovalue,'MAXSO:',MAXSO)
	})
	$('#rundca').on('click', function(e){
		SOLD = 0
		PROFIT = 0
		FEECOUNT = 0
		FEEAMOUNT = 0
		MAXSO = 0
		ADA = 0
		USD = 1000		
		bot.sellstep = parseFloat($('#sellstep').val())
		bot.buystep = parseFloat($('#sellstep').val())		
		for(x=0;x<DATA.length;x++){
			INDEX = x
			if(STOP) return
			bot.dodca()
		}
		//order value at market price
		var sovalue = bot.dcasellorder.volume * PRICE
		console.log($('#sellstep').val(),'profit:', PROFIT, 'COUNT:',SOLD,'FEES:',FEEAMOUNT, USD,'SOV:',sovalue,'TOTAL:', USD+sovalue,'MAXSO:',MAXSO)
	})


</script>