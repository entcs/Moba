<style>
	body {
		margin:0px;
		background-color:#000;
	}
	canvas{
		background-color:#eee;
	}
</style>
<meta name="viewport" content="width=device-width, initial-scale=1">
<body></body>
<script src='gg.js'></script>

<script>
gg.showframerate = true
gg.addcanvas({
	wid: '100%',
	hig: '100%',
})

var marker = gg.node(),
	range = 400,
	sight = 500,
	bulletspeed = 1000,
	movementspeed = 100,
	cooldown = 1000,
	attackspeed = 1000/cooldown
	damage = 5,
	enemyhp = 10
	
var player=gg.img({
	x:gg.canvas.width/2,
	y:gg.canvas.height/2,
	clipx:56,
	clipy:42,
	clipw:64,
	cliph:72,
	offx:-28,
	offy:-21,
	flipx:true,
	src:'heroes.png',
	pixelperfect: true,
})
<!-- player.active=true -->
<!-- player.on('mouseover',function(e){ -->
	<!-- console.log('Player stats') -->
	<!-- player.note=gg.text({ -->
		<!-- x:player.x, -->
		<!-- y:player.y, -->
		<!-- text:'Player stats' -->
	<!-- }) -->
<!-- }) -->
<!-- player.on('mouseout',function(e){ -->
	<!-- player.note.rem() -->
<!-- })	 -->

var fol = player.pos()

var c2=gg.circ({
	x:0,
	y:0,
	rad:range,
	//color:'green',
	linewid:1,
	linecolor:'#222'
})
c2.to(player)
var c3=gg.circ({
	x:0,
	y:0,
	rad:sight,
	//color:'green',
	linewid:0.5,
	linecolor:'#222'
})
c3.to(player)

var enemies=[]
gg.canvas.on('click',function(e){	
	//fol={x:gg.m.x,y:gg.m.y}
	//spawnenemy(gg.m.x,gg.m.y)
	loop(30,function(i){
		spawnenemy(30+gg.random(gg.canvas.width-60),30+gg.random(gg.canvas.height-60))
	})	
})
/*

/**/	

var bullets=[],
	bul,	
	lastshot = new Date().getTime()
	
var buffs = []
var random={},
	rng
	
function spawnenemy(x,y){
	var ene=gg.img({
		x:x,
		y:y,
		src:'heroes.png',
		clipx:190,
		clipy:40,
		clipw: 72,
		cliph:72,
		offx:-36,
		offy:-36,
		hp:enemyhp,
	})
	enemies.push(ene)
}
//buffs
function spawnbuff(x,y){	
	var b=btypes[gg.random(btypes.length)-1]
	var buff=gg.img({
		src:'items.png',
		clipx:0+b.cx,
		clipy:0+b.cy,
		clipw:42,
		cliph:28,
		offx:-21,
		offy:-14,
		//color:b.color,
		bufftype:b.type,
		description:b.description,
		x:x,
		y:y
	})
	buff.active=true
	buff.on('mouseover',function(e){
		console.log('Player stats')
		if(!buff.note || buff.note.removed){
			buff.note=gg.text({
				x:buff.x-buff.wid/2,
				y:buff.y-20,
				size:10,
				color:'grey',
				text:buff.description
			})
		}
	})
	buff.on('mouseout',function(e){
		buff.note.rem()		
	})	
	buffs.push(buff)
}
function eatbuff(b){
	if(b.bufftype=='ats'){
		attackspeed+=0.1
		cooldown=(1000/attackspeed).round(2)
	}else if(b.bufftype=='dmg'){
		damage+=1
	}else if(b.bufftype=='spd'){
		movementspeed+=10
	}else if(b.bufftype=='vis'){
		sight+=5
		c3.rad=sight
	}else if(b.bufftype=='rng'){
		range+=5
		c2.rad=range		
	}
	var bt=btexts[b.bufftype]
	bt.text=bt.updatetextval()
}
var btypes=[
	{
		type:'ats',
		description:'Attack speed',
		cx:5*42,
		cy:30*28,		
		val: function(){return 'attackspeed:'+attackspeed.round(2)}
	},
	{
		type:'dmg',
		description:'Damage',
		cx:4*42,
		cy:6*28,		
		val: function(){return 'damage:'+damage.toFixed(2)}
	},
	{
		type:'spd',
		description:'Movement speed',
		cx:5*42,
		cy:11*28,		
		val: function(){return 'movementspeed:'+movementspeed.toFixed(2)}
	},
	{
		type:'vis',
		description:'Vision',
		cx:5*42,
		cy:22*28,		
		val: function(){return 'vision:'+sight.toFixed(2)}
	},		
	{
		type:'rng',
		description:'Attack range',
		cx:2*42,
		cy:13*28,		
		val: function(){return 'range:'+range.toFixed(2)}
	}		
]
var btexts={}
loop(btypes, function(i,bt){
	console.log(20+i*10)
	btexts[bt.type]=gg.text({
		text:bt.val(),
		x:20,
		y:20+i*10,
		size:10,
		color:bt.color,		
		updatetextval:bt.val
	})	
})

//populate
loop(0,function(i){
	spawnbuff(30+gg.random(gg.canvas.width-60),30+gg.random(gg.canvas.height-60))
})
loop(50,function(i){
	spawnenemy(30+gg.random(gg.canvas.width-60),30+gg.random(gg.canvas.height-60))
})

//tasks
gg.addtask({
	name:'gameloop',
	run: function(){
		//player.fol(gg.m,movementspeed)
		//player.fol(fol,movementspeed)
		if(fol.x<player.x) {
				player.flipx=true
			} else {
				player.flipx=false
			}
			
		var tar,
			dist = sight,
			d,
			p = player.pos()
		loop(enemies,function(i,e){
			d=e.dist(p)
			if(d<dist){
				dist=d
				tar=e
			}
		})
				
		//collect buffs
		var buff
		dist = sight
		loop(buffs,function(i,b){
			if(b.dist(p)<dist){
				dist=b.dist(p)
				buff=b
			}
		})		
		if(buff){
			player.fol(buff.pos(),movementspeed)
		}
		if(tar){	
			if(tar.x<player.x) {
				player.flipx=true
			} else {
				player.flipx=false
			}
			if(tar.dist(p)<range){
				if(gg.ct>lastshot){
					lastshot = gg.ct+cooldown
					//shoot
					bul=gg.img({
						x:p.x,
						y:p.y,
						offx:-20,
						offy:-12,
						src:'fireball.png'
						
					})
					bul.tar=tar
					bul.look(tar.pos())
					bul.an-=90
					bullets.push(bul)
				}
			}else if(!buff){
				player.fol(tar,movementspeed)
			}
		}
		
		
		var deadbullets=[]
		loop(bullets,function(i,b){
			b.fol(b.tar.pos(),bulletspeed)
			dist = b.dist(b.tar.pos())
			if(!dist){
				//hit				
				b.tar.hp -= damage
				deadbullets.push(b)
				if(!b.tar.removed && b.tar.hp.round()<=0){
					//spawn buff
					var sp=b.tar.pos()
					spawnbuff(sp.x,sp.y)
				
					//dead
					if(!b.tar.removed){
						b.tar.rem()
						enemies.splice(enemies.indexOf(b.tar),1)
					}
				}
			}
		})		
		loop(deadbullets,function(i,b){
			bullets.splice(bullets.indexOf(b),1)
			b.rem()
		})	
		//eat buffs
		var rembuffs=[]
		loop(buffs,function(i,b){
			if(b.dist(p)<30){
				rembuffs.push(b)
				eatbuff(b)
			}
		})
		loop(rembuffs,function(i,b){
			buffs.splice(buffs.indexOf(b),1)
			if(b.note) b.note.rem()
			b.rem()
		})			
	}
})
/**/
/*
var l1=gg.line({
	p1:{x:200,y:200},
	p2:{x:100,y:300},	
	color:'green',
	linewid:2,
	linecolor:'#222'
})
var r1=gg.rect({
	x:300,
	y:300,
	wid:100,
	hig:100,
	//an:30,
	color:'red',
	linewid:2,
	linecolor:'#222'
})
var val=1,
	start=new Date().getTime(),
	dif,
	sin,
	freq=2,//2 1 sec,
	time=700,///(freq),
	size=0.1,
	fade

r1.on('click',function(e){
	start=new Date().getTime()
	r1.color='red'
})

r1.animate(function(dt,ct){
	dif=ct-start
	if(dif>=time){
		r1.scale(1)
	} else {		
		fade=(1-dif/time)
		//fade=Math.sqrt((1-dif/time))
		//fade*=fade
		//fade=1
		sin=Math.sin(dif*Math.PI/(time/9))*size*fade
		//console.log(dif,sin)
		r1.scale(val-sin)
	}
})
/**/
</script>