<style>
	body {
		margin:0px;
		background-color:#000;
	}
	
</style>
<meta name="viewport" content="width=device-width, initial-scale=1">
<!--
<script src="https://cdn.socket.io/socket.io-1.0.0.js"></script>
-->
<script src="node_modules\socket.io\node_modules\socket.io-client\socket.io.js"></script> 

<body></body>
<script src='d0.js'></script>
<script src='c0.js'></script>
<script>
d.on('ready',function(e){
	console.log('ready')
	var socket = io('http://localhost:1111');
	socket.on('connect', function(){
		console.log('con')
		socket.emit('event', { some: 'data' });
		socket.on('event', function(data){
			console.log('got event',data)
		});
		socket.on('disconnect', function(){
			console.log('disco')
		});
	});
})


c0.run('resize')
var gfx={	
	init:function(){
		this.c=d.body.r('canvas id=gfxcanvas')
			.s('display:none')
		this.c2=gfx.c.getContext('2d')
		var names=['tactics.png'],
			img
		this.raws={}
		this.imgs={}
		loop(names,function(i,n){
			img={
				ready:false,
				imgo:new Image()
			}
			img.imgo.src=n
			img.imgo.onload=function(){				
				img.ready=true
				d.trigger('imageloaded',[n,img])
			}
			gfx.raws[n]=img
		})
		d.on('imageloaded',function(e){
			console.log('args:',e.args)
			gfx.gen()
			d.trigger('gfxready')
		})
	},	
	clear:function(){
		console.log('clear')
		gfx.c2.clearRect(0, 0, gfx.c.width, gfx.c.height)
	},
	imgs:{},
	setsize:function(wid,hig){
		this.c.width=wid
		this.c.height=hig
	},
	draw:function(a){		
		this.c2.drawImage(a.img.imgo,a.x,a.y,64,64,0,0,64,64)
		var img=new Image()
		img.src=gfx.c.toDataURL("image/png")			
		return img		
	},
	gen:function(){
		var units={
				bswo:[[320,64],[0,64]],
				bswoh:[[320,64],[0,64],[196,64]],
				bswom:[[320,64],[0,64],[256,64]],
				bswohm:[[320,64],[0,64],[196,64],[256,64]],
				
				bsper:[[320,64],[64,64]],
				bspeh:[[320,64],[64,64],[196,64]],
				bspem:[[320,64],[64,64],[256,64]],
				bspehm:[[320,64],[64,64],[196,64],[256,64]],
				
				bbow:[[320,64],[128,64]],
				bbowh:[[320,64],[128,64],[196,64]],
				bbowm:[[320,64],[128,64],[256,64]],
				bbowhm:[[320,64],[128,64],[196,64],[256,64]],

				wswo:  [[320,0],[0,0]],
				wswoh: [[320,0],[0,0],[196,0]],
				wswom: [[320,0],[0,0],[256,0]],
				wswohm:[[320,0],[0,0],[196,0],[256,0]],
				             
				wspe: [[320,0],[64,0]],
				wspeh: [[320,0],[64,0],[196,0]],
				wspem: [[320,0],[64,0],[256,0]],
				wspehm:[[320,0],[64,0],[196,0],[256,0]],
				             
				wbow: [[320,0],[128,0]],
				wbowh: [[320,0],[128,0],[196,0]],
				wbowm: [[320,0],[128,0],[256,0]],
				wbowhm:[[320,0],[128,0],[196,0],[256,0]]
				
			}
		
		loop(units,function(name,vals){
			loop(vals,function(i2,val){
				gfx.imgs[name]=gfx.draw({
					x:val[0],
					y:val[1],
					img:gfx.raws['tactics.png']
				})
			})
			gfx.clear()
		})
						
		/*
		gfx.draw({
			x:32,
			y:32,
			wid:wid,
			hig:hig,
			offx:0,
			offy:64,
			img:gfx.raws['tactics.png']
		})
		gfx.draw({
			x:32,
			y:32,
			wid:wid,
			hig:hig,
			offx:196,
			offy:64,
			img:gfx.raws['tactics.png']
		})
		gfx.draw({
			x:32,
			y:32,
			wid:wid,
			hig:hig,
			offx:256,
			offy:64,
			img:gfx.raws['tactics.png']
		})
		var imgd=gfx.c2.getImageData(0,0,wid,hig)
		gfx.imgs['heavycavalry']=imgd
		console.log(imgd)
		/**/
	}
}
gfx.init()
gfx.setsize(64,64)
//i2.draw(gfx.c2)
var tac={	
	initmap:function(){
		var map=c0.rect({
			//src:'tactics.png',
			x:window.innerWidth/2,
			y:window.innerHeight/2,
			wid:4000,
			hig:4000,
			color:'yellowgreen',
			start:{},
			goscale:1,
			fol:0,
			vec:{x:0,y:0},
			focus:{x:0,y:0},
			mouse:{x:0,y:0},
			moved:false,
		}).to()
		
		//node layers
		map.paths=c0.node({}).to(map)
		map.terra=c0.node({}).to(map)
		map.units=c0.node({}).to(map)		
		map.gfx=c0.node({}).to(map)
		
		//bushes
		var bushes=[],
			bush,
			x,y
		loop(256,function(i){
			x=Math.random()*map.wid-map.wid/2
			y=Math.random()*map.hig-map.hig/2
			bush=c0.img({
				x:x,
				y:y,
				src:'tactics.png',
				wid:64,
				hig:64,
				offx:196,
				offy:128,
				opa:0.5
			}).to(map.terra)
		})		
		map.on('mousedown',function(e){
			console.log('map mousedown')
			map.down=true
			map.start.x=c0.m.x-map.x
			map.start.y=c0.m.y-map.y			
			map.vec.x=0
			map.vec.y=0
		})
		map.on('mouseup',function(e){
			//onclick zoom
			if(map.moved){
			
			} else {
				if(map.goscale==1 && map.down){
					tac.setscale()
				} else if(map.goscale!=1){
					tac.setscale(1)
				}
			}
					
			if(map.down){
				var pos=map.mpos()	
				//i1.pos(pos)			
				if(map.scale==1){// && map.goscale==map.scale){
					map.fol=0				
					map.vec.x=c0.mvec.x
					map.vec.y=c0.mvec.y													
				}
				map.down=false
			}
			if(tac.actunit){
				var mpos=map.mpos(),
					dot=c0.circ({
					x:mpos.x,
					y:mpos.y,
					rad:16,
					color:'rgba(255,255,255,0.3)'
				}).to(map.terra)
				tac.actunit.path.push(dot)				
			}
			tac.actunit=0			
			map.moved=false
			map.down=false
			
		})			
		map.on('mousemove',function(e){
			if(map.goscale==1){
				if(tac.actunit){
					var unit=tac.actunit,
						mpos=map.mpos(),
						pos=tac.actunit.pos()
					if(unit.path.length){
						pos=unit.path[unit.path.length-1]
					}
					var dist=c0.dist(mpos,pos)
					if(dist>64){
						var dot=c0.circ({
							x:mpos.x,
							y:mpos.y,
							rad:16,
							color:'rgba(255,255,255,0.3)'
						}).to(map.terra)
						unit.path.push(dot)
						unit.fol=0
					}
					//console.log('dist:',dist,map.mpos(),tac.actunit.pos())
				} else {					
					if(map.down && map.goscale==1){
						var dif=c0.sub(c0.m,map.start)				
						map.fol=dif
						if(dif.x!=0 || dif.y!=0){
							map.moved=true
						}
					}	
				}
			}
		})
		map.on('mousewheel',function(e){
			var dif=e.wheelDelta
			if(dif>0){
				tac.setscale(1)
			} else if(dif<0){
				tac.setscale()
			}			
		})		
		
		this.unitstats=c0.node({}).to(map.terra)
		this.unitstats.sight=c0.circ({
			rad:256,			
			color:'rgba(255,255,255,0.1)'
		}).to(this.unitstats)
		this.unitstats.range=c0.circ({
			rad:128,			
			color:'rgba(255,128,0,0.2)'
		}).to(this.unitstats)				
		tac.map=map
	},
	setscale:function(set){
		var map=tac.map
		if(set==1){
			map.goscale=1
			var mpos=map.mpos(),
				pos=map.getpos(),
				scale=map.getscale(),
				spos={
					x:mpos.x*scale,
					y:mpos.y*scale
				},
				dif=c0.sub(spos,mpos)
			
			map.fol={
				x:pos.x+dif.x,
				y:pos.y+dif.y
			}
			var mix=map.wid/2,
				miy=map.hig/2,
				max=window.innerWidth-map.wid/2,
				may=window.innerHeight-map.hig/2		
			if(map.fol.x>mix){
				map.fol.x=mix
			} else if(map.fol.x<max){
				map.fol.x=max
			}
			if(map.fol.y>miy){
				map.fol.y=miy
			} else if(map.fol.y<may){
				map.fol.y=may
			}
		} else {
			var sx=window.innerWidth/map.wid,
				sy=window.innerHeight/map.hig,
				sc=Math.min(sx,sy)
			map.goscale=sc
			map.fol={
				x:window.innerWidth/2,					
				y:window.innerHeight/2				
			}
		}								
	},
	handle:function(dt){
		this.handlemap(dt)
		this.handleunits(dt)	
		this.handlehps()
	},
	handlemap:function (){
		var smooth=4,
			map=tac.map,
			scale=map.getscale()
			mix=scale*map.wid/2,
			max=window.innerWidth-scale*map.wid/2,
			miy=scale*map.hig/2,
			may=window.innerHeight-scale*map.hig/2,
			skipx=false,
			skipy=false,
			wid=map.wid*scale,
			hig=map.hig*scale,
			sx=window.innerWidth/wid,
			sy=window.innerHeight/hig
		
		if(tac.map.scale!=tac.map.goscale){
			var sc=(tac.map.goscale-tac.map.scale)/smooth
			tac.map.scale+=sc
		}	
		if(map.goscale!=1){
			map.fol={
				x:window.innerWidth/2,					
				y:window.innerHeight/2				
			}		
		}
		if(map.fol){			
			//console.log('fol')
			var dif=c0.sub(map.fol,map.pos())
			if(Math.abs(dif.x)<0.01){
				tac.map.x=tac.map.fol.x
			} else {
				tac.map.x+=dif.x/smooth
			}
			if(Math.abs(dif.y)<0.01){
				tac.map.y=tac.map.fol.y
			} else {
				tac.map.y+=dif.y/smooth
			}
			if(map.fol.x==map.x && map.fol.y==map.y){
				map.fol=0
			}
		} else {
			//console.log('vec')
			if(map.vec.x){
				map.x+=map.vec.x
				map.vec.x*=0.9
				if(Math.abs(map.vec.x)<0.01){
					map.vec.x=0
				}
			}
			if(map.vec.y){
				map.y+=map.vec.y
				map.vec.y*=0.9
				if(Math.abs(map.vec.y)<0.01){
					map.vec.y=0
				}
				
			}
		}
		//limit min max
		if(map.scale==1){ 			
			var pos=map.getpos(),
				wid=map.wid,
				mix=wid/2-pos.x,
				miy=hig/2-pos.y,
				max=window.innerWidth-wid/2-pos.x,
				may=window.innerHeight-hig/2-pos.y
			
			if(mix<0){								
				map.x=map.wid/2
				map.fol.x=map.x
			} else if(max>0){
				map.x=window.innerWidth-wid/2
				map.fol.x=map.x				
			}			
			if(miy<0){
				map.y=map.hig/2
				map.fol.y=map.y
			} else if(may>0){
				map.y=window.innerHeight-hig/2
				map.fol.y=map.y
			}
		}
		if(Math.abs(map.scale-map.goscale)<0.0001){
			map.scale=map.goscale
		}		
	},
	getlastfol:function(unit){
		var fol
		if(unit.fol){
			fol=tac.getlastfol(unit.fol)
		} else {
			fol=unit
		}
		return fol
	},
	handleunits:function(dt){
		var dot,
			dif,
			dist,
			range=64,
			ct=new Date().getTime()
			
		loop(tac.units,function(i,unit){
			if(unit.fol){				
				dif=c0.sub(unit.fol.pos(),unit.pos())
				dist=c0.dist(dif)				
				if(unit.team!=unit.fol.team){
					range=unit.range
				} else {
					range=64
				}
				if(dist<range){
					
				} else {
					dif=c0.norm(dif)
					unit.x+=unit.speed*dif.x*dt/1000
					unit.y+=unit.speed*dif.y*dt/1000
				}				
			} else if(unit.path.length){
				dot=unit.path[0]
				dif=c0.sub(dot,unit.pos())
				dist=c0.dist(dif)
				if(dist<1){
					unit.path.splice(0,1)
					dot.rem()
				}
				if(unit.path.length){
					dot=unit.path[0]
					dif=c0.sub(dot,unit.pos())				
					dif=c0.norm(dif)
					unit.x+=unit.speed*dif.x*dt/1000
					unit.y+=unit.speed*dif.y*dt/1000
				}
			}
			//attack
			if(ct-unit.lastatt>unit.cooldown){
				unit.lastatt=ct				
				tar=tac.getclosestenemy(unit)
				if(tar){
					tac.attack(unit,tar)
				}
			}
			var rad=32*unit.hp/unit.maxhp
			if(rad<0){
				rad=0
			}
			unit.hpbar.rad=rad
		})
		
		//rem dead units
		loop(tac.units,function(i,unit){
			if(unit.hp<=0){
				tac.remunit(unit)
			}
		})
		
		if(tac.actunit){
			tac.unitstats.visible=true
			var mpos=tac.map.mpos()
			tac.unitstats.pos(mpos)//tac.actunit.pos())
			tac.unitstats.range.rad=tac.actunit.range
			tac.unitstats.sight.rad=tac.actunit.sight
		} else {
			tac.unitstats.visible=false
		}
	},
	units:[],
	pls:[],
	actunit:0,
	hps:[],
	handlehps:function(){
		var remlist=[],
			ct=new Date().getTime(),
			dif
		loop(tac.hps,function(i,hp){
			dif=1-((ct-hp.start)/300)
			hp.color='rgba(255,0,0,'+dif+')'
			hp.line.color='rgba(255,0,0,'+dif+')'
			hp.pos(hp.tar.pos())
			hp.line.p1=hp.unit.pos()
			hp.line.p2=hp.tar.pos()
			if(dif<0){
				remlist.push(hp)
			}
		})
		loop(remlist,function(i,hp){
			hp.line.rem()
			hp.rem()
			
			tac.hps.splice(tac.hps.indexOf(hp),1)
		})
	},
	attack:function(unit,tar){
		var hp=c0.circ({
			x:tar.x,
			y:tar.y,			
			color:'red',
			rad:35,
			tar:tar,
			unit:unit,
			start:new Date().getTime()			
		}).to(tac.map.terra)
		hp.line=c0.line({
			x:0,
			y:0,
			p1:unit.pos(),
			p2:tar.pos(),
			linewid:4,
			color:'red'
		}).to(tac.map.terra)
		tac.hps.push(hp)
		tar.hp-=unit.dam
	},
	getclosestenemy:function(unit){
		var tar=0,
			min=Number.MAX_VALUE,
			dist
		loop(tac.units,function(i,enemy){
			if(unit.team!=enemy.team){
				dist=c0.dist(unit,enemy)
				if(dist<unit.range+32 && dist<min){
					min=dist
					tar=enemy
				}
			}
		})
		return tar
	},
	addunit:function(a){
		var name=a.col+a.type,
			speed=64,
			sight=256,
			range=64,
			team=1,
			hp=120,
			dam=12
		if(a.col=='b'){
			team=2
		}
			
		if(a.type=='bow'){
			range+=128
			dam-=6
		}
			
		if(a.armored){
			name+='h'
			speed-=16
			sight-=32
			hp+=60
			if(a.type=='bow'){
				range+=32
			}
			
		}
		if(a.mounted){
			name+='m'
			speed+=48
			sight+=32
			if(a.type=='bow'){
				range-=64
			}			
		}	
	
		var img=gfx.imgs[name]		
		var unit=c0.imgd({
			data:img,
			x:a.x,
			y:a.y,
			wid:64,
			hig:64,
			path:[],
			fol:0,
			team:team
			//opa:0.8
		}).to(tac.map.units)
		
		unit.hpbar=c0.circ({
			rad:32,
			linewid:4,
			//linecolor:'rgba(154, 205, 50,0.7)'
			linecolor:'rgba(255, 125, 0,0.8)'
		}).to(unit)
		
		var ext={
			pl:0,
			speed:speed,
			maxhp:hp,
			hp:hp,
			dam:dam,
			range:range,
			sight:sight,
			cooldown:1000,
			lastatt:0
		}
		loop(ext,function(k,v){
			unit[k]=v
		})
		loop(a,function(k,v){
			unit[k]=v
		})
		
		unit.clearpath=function(){
			loop(unit.path,function(i,dot){
				dot.rem()
			})
			unit.path=[]
		}
		unit.on('mousedown',function(e){
			e.stop=true
			tac.actunit=e.node
			tac.actunit.fol=0
			tac.actunit.clearpath()
		})
		unit.on('mousemove',function(e){
			if(tac.actunit && tac.actunit!=e.node){
				//follow
				tac.actunit.clearpath()
				tac.actunit.fol=e.node
				if(tac.actunit.team==e.node.team){
					tac.actunit=e.node
					tac.actunit.clearpath()
				} else {
					tac.actunit=0
				}
			}
		})
		this.units.push(unit)
	},
	remunit:function(unit){
		tac.units.splice(tac.units.indexOf(unit),1)
		unit.clearpath()
		unit.hpbar.rem()
		unit.rem()
	},
	addpl:function(pl){
		this.pls[pl.name]=pl
	}
}
tac.initmap()

d.on('gfxready',function(e){
	tac.addunit({
		x:0,
		y:0,		
		col:'w',
		type:'bow',
		armored:false,
		mounted:false
	})	
	tac.addunit({
		x:64,
		y:0,		
		col:'b',
		type:'swo',
		armored:false,
		mounted:true
	})	
	
	tac.addunit({
		x:128,
		y:-400,		
		col:'w',
		type:'bow',
		armored:false,
		mounted:true
	})	
	
	tac.addunit({
		x:196,
		y:-400,		
		col:'w',
		type:'spe',
		armored:true,
		mounted:true
	})	
	
	tac.addunit({
		x:0,
		y:64,		
		col:'b',
		type:'bow',
		armored:true,
		mounted:false
	})		
	tac.addunit({
		x:64,
		y:64,		
		col:'b',
		type:'bow',
		armored:false,
		mounted:false
	})	
	
	tac.addunit({
		x:128,
		y:64,		
		col:'b',
		type:'bow',
		armored:false,
		mounted:true
	})	
	tac.addunit({
		x:196,
		y:64,		
		col:'b',
		type:'bow',
		armored:true,
		mounted:true
	})	
	/**/
})

c0.ondraw=function(dt){
	//console.log(c0.mvec)
	tac.handle(dt)
	
	/*
	if(gfx.imgs.sword){
		c0.c.drawImage(gfx.imgs.sword,0,0,64,64)
	}
	/**/
}
d.body.on('keypress',function(e){
	console.log('click1')
})
</script>